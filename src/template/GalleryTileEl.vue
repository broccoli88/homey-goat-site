<script setup>
import { useGalleryStore } from '../stores/GalleryStore'
import { useAdminGalleryStore } from '../stores/AdminGalleryStore'
import useImageObserver from '../utils/modules/useImageObserver'
import ButtonEl from './ButtonEl.vue'
import { storeToRefs } from 'pinia'
import { ref, onMounted } from 'vue'

const props = defineProps(['model', 'set'])

const galleryStore = useGalleryStore()
const { currentModel, currentFraction } = storeToRefs(galleryStore)

const adminGalleryStore = useAdminGalleryStore()
const { isInAdminPanel } = storeToRefs(adminGalleryStore)

const openModal = () => {
  currentModel.value = props.model
  currentFraction.value = props.set

  galleryStore.toggleModal()
}

// Intersection Observer

const imgRef = ref(null)
const imageObserver = useImageObserver.observeImages()

onMounted(() => {
  imageObserver.observe(imgRef.value)
})

// Admin Gallery Image Options

const showImageOptions = ref(false)

function toggleImageOptions() {
  showImageOptions.value = !showImageOptions.value
}
</script>

<template>
  <section class="miniature">
    <div class="options-btns" v-if="isInAdminPanel">
      <svg
        v-if="showImageOptions"
        @click="toggleImageOptions"
        xmlns="http://www.w3.org/2000/svg"
        width="30"
        height="30"
        viewBox="0 0 24 24"
      >
        <path
          fill="none"
          stroke="black"
          stroke-linecap="round"
          stroke-width="1.5"
          d="m14.5 9.5l-5 5m0-5l5 5M22 12c0 4.714 0 7.071-1.465 8.535C19.072 22 16.714 22 12 22s-7.071 0-8.536-1.465C2 19.072 2 16.714 2 12s0-7.071 1.464-8.536C4.93 2 7.286 2 12 2c4.714 0 7.071 0 8.535 1.464c.974.974 1.3 2.343 1.41 4.536"
        />
      </svg>
      <svg
        v-else
        @click="toggleImageOptions"
        height="100%"
        stroke-miterlimit="10"
        style="
          fill-rule: nonzero;
          clip-rule: evenodd;
          stroke-linecap: round;
          stroke-linejoin: round;
        "
        version="1.1"
        viewBox="0 0 22 22"
        width="100%"
        xml:space="preserve"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
      >
        <defs />
        <g id="cogs">
          <path
            d="M14.6105 5.07592L14.4136 6.01949C14.214 6.05088 14.0195 6.10859 13.8351 6.19112L13.1572 5.50631L12.3853 6.131L12.9133 6.93778C12.7957 7.09916 12.6996 7.27659 12.6266 7.4675L11.6622 7.46315L11.5585 8.45115L12.5021 8.64805C12.5338 8.84979 12.5922 9.04266 12.6737 9.22483L11.9889 9.90441L12.6136 10.6763L13.4203 10.1475C13.5834 10.2663 13.7616 10.363 13.9501 10.435L13.9457 11.3986L14.9337 11.5023L15.1297 10.5587C15.3317 10.527 15.526 10.4694 15.7083 10.3879L16.387 11.0727L17.1589 10.4472L16.6301 9.64125C16.7489 9.47818 16.8456 9.30005 16.9176 9.11153L17.8812 9.11503L17.9848 8.12702L17.0413 7.93185C17.0095 7.72983 16.9521 7.53485 16.8705 7.35246L17.5553 6.67462L16.9297 5.90269L16.1238 6.43067C15.9624 6.31297 15.7842 6.21615 15.5932 6.14317L15.5976 5.17956L14.6105 5.07592ZM14.7743 7.3708C14.8053 7.3709 14.8368 7.37184 14.8684 7.37515C15.3731 7.42818 15.7386 7.8802 15.6856 8.38494C15.6326 8.88965 15.1806 9.25606 14.6758 9.20302C14.1711 9.15 13.8047 8.69797 13.8577 8.19326C13.9074 7.72007 14.3085 7.36918 14.7743 7.3708ZM7.68488 7.45182L7.55246 8.76393C7.28232 8.83596 7.02644 8.94233 6.79011 9.07932L5.769 8.24468L4.808 9.20568L5.64267 10.2277C5.50567 10.4641 5.39925 10.7198 5.32728 10.99L4.01517 11.1215L4.01517 12.4807L5.32727 12.6131C5.39826 12.8798 5.50432 13.1358 5.64266 13.3746L4.80799 14.3966L5.76899 15.3576L6.79097 14.5229C7.02974 14.6612 7.2858 14.7673 7.55245 14.8383L7.68487 16.1504L9.04403 16.1504L9.17558 14.8383C9.4458 14.7663 9.70152 14.6599 9.93791 14.5229L10.9599 15.3576L11.9209 14.3966L11.0862 13.3754C11.2232 13.1391 11.3296 12.8832 11.4016 12.6131L12.7137 12.4807L12.7137 11.1215L11.4016 10.99C11.3296 10.7196 11.2234 10.4633 11.0862 10.2267L11.9209 9.20563L10.9599 8.24465L9.93879 9.07929C9.70229 8.94221 9.44594 8.83592 9.17556 8.76389L9.044 7.45179L7.68488 7.45179L7.68488 7.45182ZM8.36446 10.5439C9.05886 10.5439 9.62168 11.1067 9.62168 11.8011C9.62168 12.4955 9.05886 13.0583 8.36446 13.0583C7.67007 13.0583 7.10724 12.4955 7.10724 11.8011C7.10724 11.1067 7.67007 10.5439 8.36446 10.5439ZM14.1348 12.2228L13.9962 12.9128C13.8544 12.936 13.7183 12.9786 13.5902 13.0383L13.1128 12.5373L12.5709 12.9947L12.942 13.5846C12.8593 13.7026 12.7912 13.8326 12.7399 13.9723L12.0629 13.9688L11.9898 14.6919L12.6528 14.8357C12.6746 14.9811 12.715 15.1231 12.773 15.2582L12.2921 15.7549L12.7312 16.3194L13.2984 15.9326C13.4123 16.0191 13.5375 16.0897 13.6704 16.1426L13.6678 16.8483L14.3622 16.9241L14.4998 16.2332C14.6417 16.21 14.7777 16.1682 14.9058 16.1086L15.3833 16.6096L15.9261 16.1522L15.554 15.5623C15.6367 15.4443 15.7049 15.3142 15.7562 15.1746L16.434 15.1772L16.5063 14.4549L15.8433 14.3112C15.821 14.1634 15.7804 14.0212 15.7231 13.8878L16.204 13.392L15.7649 12.8266L15.1986 13.2134C15.0852 13.1273 14.96 13.0568 14.8257 13.0034L14.8292 12.2986L14.1348 12.2228ZM14.2498 13.9008C14.2716 13.9009 14.2938 13.9019 14.316 13.9043C14.6708 13.9431 14.9274 14.2739 14.8902 14.6432C14.8529 15.0124 14.5357 15.2805 14.1809 15.2417C13.8262 15.2029 13.5686 14.8721 13.6059 14.5029C13.6408 14.1567 13.9224 13.8996 14.2498 13.9008Z"
            fill="#000000"
            fill-rule="nonzero"
            opacity="1"
            stroke="none"
          />
        </g>
        <g id="frame">
          <path
            d="M21 11C21 15.714 21 18.071 19.535 19.535C18.072 21 15.714 21 11 21C6.286 21 3.929 21 2.464 19.535C1 18.072 1 15.714 1 11C1 6.286 1 3.929 2.464 2.464C3.93 1 6.286 1 11 1C15.714 1 18.071 1 19.535 2.464C20.509 3.438 20.835 4.807 20.945 7"
            fill="none"
            opacity="1"
            stroke="#000000"
            stroke-linecap="round"
            stroke-linejoin="miter"
            stroke-width="1.5"
          />
        </g>
      </svg>
    </div>
    <section class="miniature__tile">
      <img class="miniature__img" :data-src="model" alt="" ref="imgRef" />
      <div
        :class="isInAdminPanel ? 'miniature__options' : 'miniature__magnify'"
        @click="openModal"
        tabindex="0"
      >
        <img v-if="!isInAdminPanel" class="miniature__magnify-img" src="/svg/eye.svg" alt="" />
        <div v-else class="image-options">
          <div v-if="showImageOptions" class="options-container">
            <ButtonEl class="btn--small btn--outline-white btn--slide-white">Rename</ButtonEl>
            <ButtonEl class="btn--small btn--outline-white btn--slide-white">Delete</ButtonEl>
          </div>
        </div>
      </div>
    </section>
    <section class="miniature__description">
      <p>
        <slot></slot>
      </p>
    </section>
  </section>
</template>

<style lang="scss" scoped>
.miniature {
  position: relative;

  .options-btns {
    position: absolute;
    top: -10px;
    right: -10px;
    z-index: 999;

    background-color: white;
    display: flex;
    border-radius: 10px;
    cursor: pointer;

    box-shadow: $box-shadow-5;

    svg {
      width: 28px;
      height: 28px;
    }
  }
}

.miniature__tile {
  color: $color-white;
  font-size: 1.5rem;

  position: relative;
  cursor: pointer;

  &:hover .miniature__magnify,
  &:focus .miniature__magnify {
    opacity: 1;
  }

  .miniature__img {
    width: 100%;
    object-fit: cover;
    vertical-align: middle;
    box-shadow: $box-shadow-5;
    border-radius: 7px;
  }

  .options-container {
    display: grid;
    place-content: center;
    gap: 1.5rem;
  }

  .miniature__magnify,
  .options-container {
    background-color: hsl(0, 0%, 0%, 0.8);
    border-radius: 7px;

    display: grid;
    justify-content: center;
    align-items: center;

    position: absolute;
    inset: 0;
    z-index: 1;

    transition: $transition-03;
  }

  .miniature__magnify {
    opacity: 0;

    &:active .miniature__magnify-img {
      opacity: 0.7;
      scale: 0.9;
    }

    .miniature__magnify-img {
      width: 78px;
    }
  }
}
.miniature__description {
  margin-top: 0.6rem;
  text-transform: capitalize;
}
</style>
